---
title: 
  NestJsã®Serviceã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹
blurb:
  æ˜¨æ—¥ã‚ˆã‚Šå³å¯†ã«ãªã£ã¦ã¾ã™ã€‚
author: kochie
jumbotron:
  src: image.png
  alt: doge
publishedDate: 2023-07-31T12:00:00+12:00
---


## NestJsã®Serviceã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹

### ã‚µãƒ¼ãƒ“ã‚¹

æ˜¨æ—¥ã¾ã§ã¯`controller`ã®ä¸­ã§å‡¦ç†ã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

ã‚ˆã‚Šè©³ç´°ãªãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€åŠ å·¥ã€æ“ä½œã€å‡¦ç†ãªã©ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«`service`ã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚

Serviceãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€`@Injectable()`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦Nest.jsã«ã‚ˆã‚‹ä¾å­˜æ€§æ³¨å…¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Serviceã¯ä»–ã®ã‚¯ãƒ©ã‚¹ã¨é€£æºã—ã‚„ã™ããªã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã¨ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚



### ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™

æ˜¨æ—¥ã¾ã§ã®ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã€‚



### ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 

ã¾ãšã¯`getAllReports`ã®å‡¦ç†ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¾ã™ã€‚

ï¼Šã‚¯ãƒ©ã‚¹ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç†è§£ãŒå¿…è¦ã§ã™ã€‚ã‚ã‹ã‚“ãªã„ã‚ˆã£ã¦æ–¹ã¯MDNã¿ã¦ãã ã•ã„ã€‚

> [ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã¤ã„ã¦](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Classes/constructor)



`src/app.service.ts`

```typescript
import { HttpException, HttpStatus, Injectable } from '@nestjs/common';
import { ReportType } from './types/type';
import { data } from './data/data';

@Injectable()
export class AppService {
  getAllReports(type: ReportType) {
    try {
      const filteredReports = data.report.filter((report) => report.type === type);
      return filteredReports;
    } catch (error) {
      throw error;
    }
  }
}
```

@Injectable()ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Nest.jsãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯AppServiceã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¿…è¦ã¨ã™ã‚‹ä»–ã®ã‚¯ãƒ©ã‚¹ã«è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ä»–ã®ã‚¯ãƒ©ã‚¹ã§AppServiceã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã€ãã‚Œã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•°ã¨ã—ã¦å®£è¨€ã™ã‚‹ã ã‘ã§ã€ãã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ï¼š

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å®£è¨€ã—ã¦`reportType`ã®å–å¾—ã‚’ã—ã¦ã¿ã¾ã™ã€‚

`src/app.controller.ts`

```typescript
import { AppService } from './app.service';
//...

@Controller('report/:type')
export class AppController {

  constructor(
    private readonly appService: AppService
  ) { }
@Get()
  getAllReports(@Param('type') type: string) {
    // const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    const reportType = (type: string): ReportType => {
      switch (type) {
        case 'income':
          return ReportType.INCOME
        case 'expense':
          return ReportType.EXPENSE
        default:
          throw new HttpException('ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚: ' + type, HttpStatus.BAD_REQUEST);
      }
    }

    return this.appService.getAllReports(reportType(type))
  }
  //...
```



### å‹•ä½œç¢ºèª

åŒã˜å‹•ä½œãŒã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

`report`ã‚’ä½œæˆ

![](/create-report.png?width=1600&height=2080)



ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

![](/getAllReport1.png?width=1600&height=2080)

ã€€è¿½åŠ ã§ãã¦ã„ã¾ã™ã€‚







### ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤

åŒã˜ã‚ˆã†ã«`getReportById`,`createReport`,`updateReport`,`deleteReport`ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ä¸€æ°—ã«ä½œã£ã¦ã„ãã¾ã™ã€‚



`src/app.service.ts`

```typescript
import { HttpException, HttpStatus, Injectable } from '@nestjs/common';
import { v4 as uuid } from 'uuid'

import { ReportType } from './types/type';
import { data } from './data/data';

interface Report {
  source: string
  amount: number
}

@Injectable()
export class AppService {
 //...
  getReportById(type: ReportType, id: string) {
    const filteredReports = data.report.filter((report) => report.type === type);
    const reportById = filteredReports.find((report) => report.id === id);

    if (!reportById) {
      throw new HttpException('åˆ©ç”¨ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', HttpStatus.NOT_FOUND);
    }
    return reportById;
  }

  createReport(type: ReportType, { source, amount }: Report) {
    const newReport = {
      id: uuid(),
      source,
      amount,
      created_at: new Date(),
      updated_at: new Date(),
      type: type
    }
    data.report.push(newReport)
    return newReport
  }

  updateReport(type: ReportType, id: string, body: Report) {
    const filteredReports = data.report.filter((report) => report.type === type);
    const reportUpdateById = filteredReports.find((report) => report.id === id);

    if (!reportUpdateById) {
      throw new HttpException('åˆ©ç”¨ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', HttpStatus.NOT_FOUND);
    }

    const reportUpdatedById = data.report.findIndex((report) => report.id === reportUpdateById.id)

    data.report[reportUpdatedById] = {
      ...data.report[reportUpdatedById],
      ...body,
      updated_at: new Date()
    }

    return data.report[reportUpdatedById];
  }

  deleteReport(id: string,) {
    const reportIndex = data.report.findIndex((report) => report.id === id);

    if (reportIndex === -1) {
      throw new HttpException('æŒ‡å®šã—ãŸidã®ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ã¾ã›ã‚“', HttpStatus.NOT_FOUND);
    }

    data.report.splice(reportIndex, 1)

    return
  }
}

```



#### ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸéƒ¨åˆ†

```typescript
//å¤‰æ›´å‰ src/app.controller.ts
const filteredReports = data.report.filter((report) => report.type === reportType(type);

//å¤‰æ›´å¾Œ src/app.service.ts
const filteredReports = data.report.filter((report) => report.type === type);
```

`reportType`ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§`type`ã®åˆ¤åˆ¥ã‚’ã™ã‚‹ãŸã‚ã«ä½œã£ã¦ã„ã‚‹ãŸã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯å‹ã®åˆ¤å®šãŒã§ãã‚Œã°ã„ã„ã®ã§ãã®ã¾ã¾`type`ã¨ã—ã¦ã„ã¾ã™ã€‚



```typescript
//å¤‰æ›´å‰ src/app.controller.ts
{ source, amount }:
    {
      source: string
      amount: number
    },
      
//å¤‰æ›´å¾Œ src/app.service.ts
interface Report {
  source: string
  amount: number
}
//...
 updateReport(type: ReportType, id: string, body: Report)
```

å‹ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ãŸã»ã†ãŒã‚³ãƒ¼ãƒ‰ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚



```typescript
//å¤‰æ›´å‰ src/app.controller.ts
data.report[reportUpdatedById] = {
      ...data.report[reportUpdatedById],
      ...body
    }


//å¤‰æ›´å¾Œ src/app.service.ts
data.report[reportUpdatedById] = {
      ...data.report[reportUpdatedById],
      ...body,
      updated_at: new Date()
    }
```

`updated_at: new Date()`ã“ã‚Œã¯å¿˜ã‚Œã¦ã„ãŸã®ã§å…¥ã‚Œã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãŸæ—¥æ™‚ãŒåˆ†ã‹ã£ãŸã»ã†ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚





`src/app.controller.ts`

```typescript
//...

@Controller('report/:type')
export class AppController {

  constructor(
    private readonly appService: AppService
  ) { }

//...
  
  @Get(':id')
  getReportById(@Param('type') type: string, @Param('id') id: string) {
    const reportType = (type: string): ReportType => {
      switch (type) {
        case 'income':
          return ReportType.INCOME
        case 'expense':
          return ReportType.EXPENSE
        default:
          throw new HttpException('ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚: ' + type, HttpStatus.BAD_REQUEST);
      }
    }
    return this.appService.getReportById(reportType(type), id)
  }

  @Post()
  createReport(
    @Body() { source, amount }: {
      source: string
      amount: number
    },
    @Param('type') type: string
  ) {
    const reportType = (type: string): ReportType => {
      switch (type) {
        case 'income':
          return ReportType.INCOME
        case 'expense':
          return ReportType.EXPENSE
        default:
          throw new HttpException('ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚: ' + type, HttpStatus.BAD_REQUEST);
      }
    }
    return this.appService.createReport(reportType(type), { source, amount })
  }

  @Put(':id')
  updateReport(
    @Param('type') type: string,
    @Param('id') id: string,
    @Body() body: {
      source: string
      amount: number
    }
  ) {
    const reportType = (type: string): ReportType => {
      switch (type) {
        case 'income':
          return ReportType.INCOME
        case 'expense':
          return ReportType.EXPENSE
        default:
          throw new HttpException('ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚: ' + type, HttpStatus.BAD_REQUEST);
      }
    }
    return this.appService.updateReport(reportType(type), id, body)
  }

  @HttpCode(204)
  @Delete(':id')
  deleteReport(
    @Param('id') id: string
  ) {

    return this.appService.deleteReport(id)
  }

}
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã®éƒ¨åˆ†ã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»è¡Œã—ãŸã®ã§ã‚³ãƒ¼ãƒ‰ãŒã‚¹ãƒƒã‚­ãƒªã—ãŸã¨æ€ã„ã¾ã™ã€‚



### ãƒ‘ã‚¤ãƒ—ã£ã¦æ©Ÿèƒ½ãŒã‚ã‚‹ã‚‰ã—ã„

ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã†ã“ã¨ã§ã‚³ãƒ¼ãƒ‰ã‚’ã‚ˆã‚Šç°¡æ½”ã«ã§ããã†ã§ã™ã€‚

ä»¥ä¸‹ã¯GPTå…ˆç”Ÿã«ãƒ‘ã‚¤ãƒ—ãŒä½•ã‹èã„ãŸã‚‚ã®ã§ã™ã€‚

Nest.jsã®ãƒ‘ã‚¤ãƒ—ï¼ˆPipeï¼‰ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã€æ¤œè¨¼ã€åŠ å·¥ã™ã‚‹ãŸã‚ã®ä¸­é–“å‡¦ç†ã‚’è¡Œã†æ©Ÿèƒ½ã§ã™ã€‚ãƒ‘ã‚¤ãƒ—ã¯ä¸»ã«ä»¥ä¸‹ã®ã‚ˆã†ãªç›®çš„ã§ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

1. ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›®çš„ã®å½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã—ãŸã‚Šã€æ–‡å­—åˆ—ã‚’æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ãŸã‚Šã™ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚
2. ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã—ã€ç‰¹å®šã®æ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ä¾‹ãˆã°ã€å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ã€æ–‡å­—åˆ—ã®é•·ã•ãŒåˆ¶é™å†…ã‹ã€å€¤ãŒæœ‰åŠ¹ãªç¯„å›²å†…ã«ã‚ã‚‹ã‹ãªã©ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
3. ãƒ‡ãƒ¼ã‚¿ã®åŠ å·¥: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã—ã€ç‰¹å®šã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦å¤‰æ›´ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€æ–‡å­—åˆ—ã®ãƒˆãƒªãƒŸãƒ³ã‚°ã€ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã‚’éš ã™ï¼ˆãƒã‚¹ã‚¯ã™ã‚‹ï¼‰ãªã©ã®åŠ å·¥ã‚’è¡Œã„ã¾ã™ã€‚
4. ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹å‰ã«ã€äº‹å‰ã«ç‰¹å®šã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ã€ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ãªã©ã®å‰å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚



ä»Šã¾ã§æ›¸ã„ã¦ãŸã‚³ãƒ¼ãƒ‰ã§ã¨ã¦ã‚‚å†—é•·ãªã‚‚ã®ãŒã‚ã‚Šã¾ã—ãŸã‚ˆã­ğŸ˜­

```typescript
//ã“ã‚Œã§ã™
const reportType = (type: string): ReportType => {
       switch (type) {
         case 'income':
           return ReportType.INCOME
         case 'expense':
           return ReportType.EXPENSE
         default:
           throw new HttpException('ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚: ' + type, HttpStatus.BAD_REQUEST);
       }
     }
```



ä¸‰é …æ¼”ç®—å­ã§`type`ã®å³å¯†ãªåˆ†å²ã‚’å®Ÿç¾ã§ãã‚‹ã¿ãŸã„ã§ã™ã­ã€‚

```typescript
 getAllReports(@Param('type', new ParseEnumPipe(ReportType)) type: string) {
    const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    return this.appService.getAllReports(reportType)
  }
```



ã¤ã„ã§ã«`id`ã«ã‚‚`ParseUUIDPipe`ã‚’ä½¿ã„ã¾ã™ã€‚

```typescript
@Get(':id')
  getReportById(@Param('type', new ParseEnumPipe(ReportType)) type: string, @Param('id', ParseUUIDPipe) id: string) {
    //...
  }
```



ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’`ParseEnumPipe`,`ParseUUIDPipe`ã‚’ä½¿ã£ã¦æ›¸ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
//...

  @Get()
  getAllReports(@Param('type', new ParseEnumPipe(ReportType)) type: string) {
    const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    return this.appService.getAllReports(reportType)
  }
  @Get(':id')
  getReportById(@Param('type', new ParseEnumPipe(ReportType)) type: string, @Param('id', ParseUUIDPipe) id: string) {
    const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    return this.appService.getReportById(reportType, id)
  }

  @Post()
  createReport(
    @Body() { source, amount }: {
      source: string
      amount: number
    },
    @Param('type', new ParseEnumPipe(ReportType)) type: string
  ) {
    const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    return this.appService.createReport(reportType, { source, amount })
  }
  @Put(':id')
  updateReport(
    @Param('type', new ParseEnumPipe(ReportType)) type: string,
    @Param('id', ParseUUIDPipe) id: string,
    @Body() body: {
      source: string
      amount: number
    }
  ) {
    const reportType = type === 'income' ? ReportType.INCOME : ReportType.EXPENSE
    return this.appService.updateReport(reportType, id, body)
  }
  @HttpCode(204)
  @Delete(':id')
  deleteReport(
    @Param('id', ParseUUIDPipe) id: string
  ) {
    return this.appService.deleteReport(id)
  }
```

å…¨ä½“ã‚’è¦‹ã‚‹ã¨ã‚³ãƒ¼ãƒ‰é‡ãŒ4åˆ†ã®1ãã‚‰ã„æ¸›ã‚Šã¾ã—ãŸã­ğŸ˜



### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å³å¯†ã«ã™ã‚‹

å®Ÿã¯`PUT`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ãã€`sourse`ã‚’`string`ä»¥å¤–ã®å½¢å¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’é€šã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒã‚°ç™ºç”Ÿã®åŸå› ã«ãªã‚‹ã®ã§`sourse, amount`ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æ¡ä»¶ã‚’è¶³ã—ã¦ã„ãã¾ã™ã€‚



ã¾ãšã¯å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
ï¼„npm i class-transformer class-validator 
```



**`dto`ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šã¾ã™ã€‚**

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã§ã¯ã€NextJsã®ãƒ‘ã‚¤ãƒ—ã‚„ã®ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã„ã“ãªã—ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§èµ·ã“ã‚Šã†ã‚‹ã‚¨ãƒ©ãƒ¼ã‚„ãƒã‚°ã®è§£æ±ºã‚’ã—ã¦ã„ã¾ã™ã€‚





`createReport`ã®`@Body`ã«å«ã‚ã‚‹` source: string,amount: number`ã‚’æŠœãå–ã‚Šãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ã„ãã¾ã™ã€‚

`src/dtos/report.dtos.ts`

```typescript
import { IsNotEmpty, IsNumber, IsPositive, IsString } from "class-validator"

export class CreateReportDto {
  @IsString()
  @IsNotEmpty()
  source: string

  @IsNumber()
  @IsPositive()
  amount: number
}
```



ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®æ–¹ã«ã¯ä»Šä½œã£ãŸã‚¯ãƒ©ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

`src/app.controller.ts`

```typescript
import { CreateReportDto } from './dtos/report.dtos';

@Post()
  createReport(
    @Body() { source, amount }: CreateReportDto,
    @Param('type', new ParseEnumPipe(ReportType)) type: string
  ) {
  //...
  }
```



æœ€å¾Œã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã†ãŸã‚`main.ts`ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚

```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe()) //è¿½åŠ 
  await app.listen(3000);
}
bootstrap();
```

`app.useGlobalPipes(new ValidationPipe())`: ã“ã®è¡Œã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¤ãƒ—ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¤ãƒ—ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§å…±é€šã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã—ã¾ã™ã€‚`ValidationPipe`ã¯ã€`@nestjs/common`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚‚ã®ã§ã€ã‚¯ãƒ©ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«é©ç”¨ã—ã¾ã™ã€‚





### å‹•ä½œç¢ºèª

![](/notEmpty.png?width=1600&height=2080)

![](/notString.png?width=1600&height=2080)

ã¡ã‚ƒã‚“ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã¾ã™ã­ã€‚



### æ©Ÿå¯†æ€§ã‚’ã‚‚ã£ã¨ã‚ã’ã‚ˆã†

ã¾ãšã¯ã€`updateReport`ã§ã™ã€‚

`src/dtos/report.dtos.ts`

```typescript
//...
export class UpdateReportDto {
  @IsString()
  @IsNotEmpty()
  source: string

  @IsOptional()
  @IsNumber()
  @IsPositive()
  amount: number
}
```

`src/app.controller.ts`

```typescript
//...
@Put(':id')
  updateReport(
    @Param('type', new ParseEnumPipe(ReportType)) type: string,
    @Param('id', ParseUUIDPipe) id: string,
    @Body() body: UpdateReportDto,
  ) {
    //...
  }
```

`src/app.service.ts`

```typescript
interface UpdateReport {
  source?: string
  amount?: number
}

//...

updateReport(type: ReportType, id: string, body: UpdateReport) {
   //...
    }
```

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æ™‚ã¯ã€Œã‚„ã£ã±ã‚Šå¤‰æ›´ã—ãªã„ã€ã£ã¦ã“ã¨ãŒã‚ã‚‹ã®ã§`body`ã¯**å¿…é ˆã«ã—ãªã„**ã‚ˆã†ã«ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯`interface`ã«`?ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒã‚§ãƒ¼ãƒ³ï¼‰`ã‚’ã¤ã‘ã¾ã™ã€‚

TypeScriptã§ã¯ã‚ˆãä½¿ã†è¨˜è¿°ãªã®ã§ã—ã£ã‹ã‚Šè¦šãˆã¾ã—ã‚‡ã†ï¼





### çŸ¥ã‚‰ãªã„å‹ãƒ‡ãƒ¼ã‚¿ã¯æ›¸ãè¾¼ã¾ãªã„ï¼ˆæ›¸ãè¾¼ã¾ã›ãªã„ï¼‰

ç¾çŠ¶ã§ã¯ã€`nonType`ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚é€ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã™ã€‚

```bash
{ source: 'aws', amount: 8000, nonType: 'any' }
```

ã“ã‚Œã§ã¯é–“é•ãˆã¦çŸ¥ã‚‰ãªã„ãƒ‡ãƒ¼ã‚¿é€ã£ã¡ã‚ƒãŸå ´åˆã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™ã®ãŒé¢å€’ã«ãªã‚Šãã†ã§ã™ã­ã—ã€ãªã‚Šã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒæ‚ªã„ã§ã™ã€‚



ã§ã™ã®ã§ã€å‹å®šç¾©ã—ã¦ãªã„ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ç„¡è¦–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`src/main.ts`

```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,
  }))
  await app.listen(3000);
}
bootstrap();
```

`ValidationPipe`ã®`whitelist`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®éš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœªçŸ¥ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’çœç•¥ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’`true`ã«è¨­å®šã™ã‚‹ã¨ã€æœªçŸ¥ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè‡ªå‹•çš„ã«çœç•¥ã•ã‚Œã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«å®šç¾©ã•ã‚Œã¦ã„ãªã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒç„¡è¦–ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€`whitelist: true`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«ä¸å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¸¡ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


ä»Šæ—¥ã¯ã»ã‚“ã¨ã«ã¾ã ç¶šãã¾ã™ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼